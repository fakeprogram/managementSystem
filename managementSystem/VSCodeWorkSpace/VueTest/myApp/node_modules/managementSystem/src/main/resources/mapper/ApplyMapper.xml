<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.managementSystem.mapper.ApplyMapper">
  <resultMap id="BaseResultMap" type="com.example.managementSystem.entity.Apply">
    <id column="apply_id" jdbcType="INTEGER" property="applyId" />
    <result column="task_id" jdbcType="INTEGER" property="taskId" />
    <result column="task_name" jdbcType="VARCHAR" property="taskName" />
    <result column="user_id" jdbcType="INTEGER" property="userId" />
    <result column="user_name" jdbcType="VARCHAR" property="userName" />
    <result column="department_name" jdbcType="VARCHAR" property="departmentName" />
    <result column="address" jdbcType="VARCHAR" property="address" />
    <result column="apply_time" jdbcType="TIMESTAMP" property="applyTime" />
    <result column="departure_time" jdbcType="TIMESTAMP" property="departureTime" />
    <result column="return_time" jdbcType="TIMESTAMP" property="returnTime" />
    <result column="apply_status" jdbcType="INTEGER" property="applyStatus" />
    <result column="vehicle" jdbcType="VARCHAR" property="vehicle" />
    <result column="total_cost" jdbcType="DECIMAL" property="totalCost" />
    <result column="transportation_expense" jdbcType="DECIMAL" property="transportationExpense" />
    <result column="hotel_expense" jdbcType="DECIMAL" property="hotelExpense" />
    <result column="catering_expenses" jdbcType="DECIMAL" property="cateringExpenses" />
    <result column="other_expenses" jdbcType="DECIMAL" property="otherExpenses" />
    <result column="days" jdbcType="INTEGER" property="days" />
  </resultMap>

  <!---->
  <resultMap id="ApplicationWithAudit" type="com.example.managementSystem.entity.vo.ApplicationWithAudit">
    <id column="apply_id" jdbcType="INTEGER" property="applyId" />
    <result column="task_id" jdbcType="INTEGER" property="taskId" />
    <result column="task_name" jdbcType="VARCHAR" property="taskName" />
    <result column="user_id" jdbcType="INTEGER" property="userId" />
    <result column="user_name" jdbcType="VARCHAR" property="userName" />
    <result column="department_name" jdbcType="VARCHAR" property="departmentName" />
    <result column="address" jdbcType="VARCHAR" property="address" />
    <result column="apply_time" jdbcType="TIMESTAMP" property="applyTime" />
    <result column="departure_time" jdbcType="TIMESTAMP" property="departureTime" />
    <result column="return_time" jdbcType="TIMESTAMP" property="returnTime" />
    <result column="apply_status" jdbcType="INTEGER" property="applyStatus" />
    <result column="vehicle" jdbcType="VARCHAR" property="vehicle" />
    <result column="total_cost" jdbcType="DECIMAL" property="totalCost" />
    <result column="transportation_expense" jdbcType="DECIMAL" property="transportationExpense" />
    <result column="hotel_expense" jdbcType="DECIMAL" property="hotelExpense" />
    <result column="catering_expenses" jdbcType="DECIMAL" property="cateringExpenses" />
    <result column="other_expenses" jdbcType="DECIMAL" property="otherExpenses" />
    <result column="days" jdbcType="INTEGER" property="days" />
    <!---->
    <result column="auditor_id" jdbcType="INTEGER" property="auditorId" />
    <result column="auditor_name" jdbcType="VARCHAR" property="auditorName" />
    <result column="opinions" jdbcType="VARCHAR" property="opinions" />
    <result column="audit_time" jdbcType="TIMESTAMP" property="auditTime" />
    <result column="is_pass" jdbcType="INTEGER" property="isPass" />
  </resultMap>
  
  <sql id="AuditInfo">
    auditor as auditor_id,opinions,audit_time,is_pass
  </sql>
  <sql id="Base_Column_List">
    apply.apply_id, task_id,task_name, apply.user_id,apply.user_name,department_name,address,apply_time, departure_time, return_time, apply_status,
    vehicle, total_cost, transportation_expense, hotel_expense, catering_expenses, other_expenses, 
    `days`
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.Integer" resultMap="BaseResultMap">
    select 
    <include refid="Base_Column_List" />
    from apply
    where apply_id = #{applyId,jdbcType=INTEGER}
  </select>

  <!--是否已经申请成功-->
  <select id="hasSuccessfulApplication" parameterType="java.lang.Integer" resultType="java.lang.Integer">
    select count(*) as num
      from audit_application left join apply on apply.apply_id=audit_application.apply_id
      where user_id=#{userId} and apply.task_id =#{taskId} and audit_application.is_pass=1
  </select>

  <!--通过申请者和审核者共同的部门id获取未审核的申请-->
  <select id="getUnAuditedApplicationByDepartmentId" parameterType="java.lang.Integer" resultMap="BaseResultMap">
    select
    <include refid="Base_Column_List" />
    from apply left join users on apply.user_id=users.user_id
    where users.department_id = #{departmentId,jdbcType=INTEGER} and apply_status=0
  </select>

  <!--获取所有未审核的申请-->
  <select id="getAllUnAuditedApplication" parameterType="java.lang.Integer" resultMap="BaseResultMap">
    select
    <include refid="Base_Column_List" />
    from apply
    where apply_status=0
  </select>

  <!--通过id获取我的申请记录-->
  <select id="getMyApplication" parameterType="java.lang.Integer" resultMap="ApplicationWithAudit">
    select
    <include refid="Base_Column_List"/>,
    <include refid="AuditInfo"/>,
    users.user_name as auditor_name
    from apply left join audit_application on apply.apply_id = audit_application.apply_id
    left join users on audit_application.auditor=users.user_id
    where apply.user_id =#{userId} order by apply.apply_time DESC
  </select>

  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
    delete from apply
    where apply_id = #{applyId,jdbcType=INTEGER}
  </delete>
  <insert id="insert" keyColumn="apply_id" keyProperty="applyId" parameterType="com.example.managementSystem.entity.Apply" useGeneratedKeys="true">
    insert into apply (task_id,task_name, user_id,user_name,department_name,address,apply_time,
      departure_time, return_time, apply_status, 
      vehicle, total_cost, transportation_expense, 
      hotel_expense, catering_expenses, other_expenses, 
      `days`)
    values (#{taskId,jdbcType=INTEGER},#{taskName}, #{userId,jdbcType=INTEGER},#{userName}, #{departmentName},#{address},#{applyTime,jdbcType=TIMESTAMP},
      #{departureTime,jdbcType=TIMESTAMP}, #{returnTime,jdbcType=TIMESTAMP}, #{applyStatus,jdbcType=INTEGER}, 
      #{vehicle,jdbcType=VARCHAR}, #{totalCost,jdbcType=DECIMAL}, #{transportationExpense,jdbcType=DECIMAL}, 
      #{hotelExpense,jdbcType=DECIMAL}, #{cateringExpenses,jdbcType=DECIMAL}, #{otherExpenses,jdbcType=DECIMAL}, 
      #{days,jdbcType=INTEGER})
  </insert>
  <insert id="insertSelective" keyColumn="apply_id" keyProperty="applyId" parameterType="com.example.managementSystem.entity.Apply" useGeneratedKeys="true">
    insert into apply
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="taskId != null">
        task_id,
      </if>
      <if test="taskName != null">
        task_name,
      </if>
      <if test="userId != null">
        user_id,
      </if>
      <if test="userName != null">
        user_name,
      </if>
      <if test="departmentName != null">
        department_name,
      </if>
      <if test="address != null">
        address,
      </if>
      <if test="applyTime != null">
        apply_time,
      </if>
      <if test="departureTime != null">
        departure_time,
      </if>
      <if test="returnTime != null">
        return_time,
      </if>
      <if test="applyStatus != null">
        apply_status,
      </if>
      <if test="vehicle != null">
        vehicle,
      </if>
      <if test="totalCost != null">
        total_cost,
      </if>
      <if test="transportationExpense != null">
        transportation_expense,
      </if>
      <if test="hotelExpense != null">
        hotel_expense,
      </if>
      <if test="cateringExpenses != null">
        catering_expenses,
      </if>
      <if test="otherExpenses != null">
        other_expenses,
      </if>
      <if test="days != null">
        `days`,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="taskId != null">
        #{taskId,jdbcType=INTEGER},
      </if>
      <if test="taskName != null">
        #{taskName,jdbcType=VARCHAR},
      </if>
      <if test="userId != null">
        #{userId,jdbcType=INTEGER},
      </if>
      <if test="userName != null">
        #{userName,jdbcType=VARCHAR},
      </if>
      <if test="departmentName != null">
        #{departmentName,jdbcType=VARCHAR},
      </if>
      <if test="address != null">
        #{address,jdbcType=VARCHAR},
      </if>
      <if test="applyTime != null">
        #{applyTime,jdbcType=TIMESTAMP},
      </if>
      <if test="departureTime != null">
        #{departureTime,jdbcType=TIMESTAMP},
      </if>
      <if test="returnTime != null">
        #{returnTime,jdbcType=TIMESTAMP},
      </if>
      <if test="applyStatus != null">
        #{applyStatus,jdbcType=INTEGER},
      </if>
      <if test="vehicle != null">
        #{vehicle,jdbcType=VARCHAR},
      </if>
      <if test="totalCost != null">
        #{totalCost,jdbcType=DECIMAL},
      </if>
      <if test="transportationExpense != null">
        #{transportationExpense,jdbcType=DECIMAL},
      </if>
      <if test="hotelExpense != null">
        #{hotelExpense,jdbcType=DECIMAL},
      </if>
      <if test="cateringExpenses != null">
        #{cateringExpenses,jdbcType=DECIMAL},
      </if>
      <if test="otherExpenses != null">
        #{otherExpenses,jdbcType=DECIMAL},
      </if>
      <if test="days != null">
        #{days,jdbcType=INTEGER},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.example.managementSystem.entity.Apply">
    update apply
    <set>
      <if test="taskId != null">
        task_id = #{taskId,jdbcType=INTEGER},
      </if>
      <if test="taskName != null">
        task_name = #{taskName,jdbcType=VARCHAR},
      </if>
      <if test="userId != null">
        user_id = #{userId,jdbcType=INTEGER},
      </if>
      <if test="userName != null">
        user_name = #{userName,jdbcType=VARCHAR},
      </if>
      <if test="departmentName != null">
        department_name = #{departmentName,jdbcType=VARCHAR},
      </if>
      <if test="address != null">
        address = #{address,jdbcType=VARCHAR},
      </if>
      <if test="applyTime != null">
        apply_time = #{applyTime,jdbcType=TIMESTAMP},
      </if>
      <if test="departureTime != null">
        departure_time = #{departureTime,jdbcType=TIMESTAMP},
      </if>
      <if test="returnTime != null">
        return_time = #{returnTime,jdbcType=TIMESTAMP},
      </if>
      <if test="applyStatus != null">
        apply_status = #{applyStatus,jdbcType=INTEGER},
      </if>
      <if test="vehicle != null">
        vehicle = #{vehicle,jdbcType=VARCHAR},
      </if>
      <if test="totalCost != null">
        total_cost = #{totalCost,jdbcType=DECIMAL},
      </if>
      <if test="transportationExpense != null">
        transportation_expense = #{transportationExpense,jdbcType=DECIMAL},
      </if>
      <if test="hotelExpense != null">
        hotel_expense = #{hotelExpense,jdbcType=DECIMAL},
      </if>
      <if test="cateringExpenses != null">
        catering_expenses = #{cateringExpenses,jdbcType=DECIMAL},
      </if>
      <if test="otherExpenses != null">
        other_expenses = #{otherExpenses,jdbcType=DECIMAL},
      </if>
      <if test="days != null">
        `days` = #{days,jdbcType=INTEGER},
      </if>
    </set>
    where apply_id = #{applyId,jdbcType=INTEGER}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.example.managementSystem.entity.Apply">
    update apply
    set task_id = #{taskId,jdbcType=INTEGER},
      task_name =#{taskName},
      user_id = #{userId,jdbcType=INTEGER},
      user_name=#{userName},
      department_name=#{departmentName},
      address=#{address},
      apply_time = #{applyTime,jdbcType=TIMESTAMP},
      departure_time = #{departureTime,jdbcType=TIMESTAMP},
      return_time = #{returnTime,jdbcType=TIMESTAMP},
      apply_status = #{applyStatus,jdbcType=INTEGER},
      vehicle = #{vehicle,jdbcType=VARCHAR},
      total_cost = #{totalCost,jdbcType=DECIMAL},
      transportation_expense = #{transportationExpense,jdbcType=DECIMAL},
      hotel_expense = #{hotelExpense,jdbcType=DECIMAL},
      catering_expenses = #{cateringExpenses,jdbcType=DECIMAL},
      other_expenses = #{otherExpenses,jdbcType=DECIMAL},
      `days` = #{days,jdbcType=INTEGER}
    where apply_id = #{applyId,jdbcType=INTEGER}
  </update>
</mapper>